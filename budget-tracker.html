<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Presupuesto Personal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card.expense {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .stat-card.income {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .stat-card.savings {
            background: linear-gradient(135deg, #91eae4 0%, #86a8e7 100%);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .category-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-category {
            font-weight: 600;
            color: #333;
        }

        .transaction-description {
            font-size: 0.9rem;
            color: #666;
            margin-top: 2px;
        }

        .transaction-amount {
            font-weight: bold;
            color: #e74c3c;
        }

        .transaction-date {
            font-size: 0.8rem;
            color: #999;
        }

        .credit-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-name {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .card-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .card-balance {
            margin-bottom: 10px;
        }

        .balance-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .balance-fill {
            height: 100%;
            background: rgba(255,255,255,0.8);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .suggestions {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
        }

        .suggestion-icon {
            font-size: 1.2rem;
            color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .export-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-calculator"></i> Gestor de Presupuesto Personal</h1>
            <p>Controla tus finanzas de manera inteligente</p>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card income">
                <div class="stat-value" id="totalIncomeDisplay">$0</div>
                <div class="stat-label">Ingresos Totales</div>
            </div>
            <div class="stat-card expense">
                <div class="stat-value" id="totalExpensesDisplay">$0</div>
                <div class="stat-label">Gastos Totales</div>
            </div>
            <div class="stat-card savings">
                <div class="stat-value" id="totalSavingsDisplay">$0</div>
                <div class="stat-label">Ahorros</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="budgetUsageDisplay">0%</div>
                <div class="stat-label">Uso del Presupuesto</div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard">
            <!-- Budget Categories Card -->
            <div class="card">
                <h3><i class="fas fa-list"></i> Categorías de Presupuesto</h3>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('categories-view')">Ver</div>
                    <div class="tab" onclick="switchTab('categories-add')">Agregar</div>
                </div>
                
                <div id="categories-view" class="tab-content active">
                    <div id="categoriesList"></div>
                </div>
                
                <div id="categories-add" class="tab-content">
                    <form id="categoryForm">
                        <div class="form-group">
                            <label for="categoryName">Nombre de Categoría</label>
                            <input type="text" id="categoryName" required>
                        </div>
                        <div class="form-group">
                            <label for="categoryBudget">Presupuesto</label>
                            <input type="number" id="categoryBudget" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="categoryColor">Color</label>
                            <input type="color" id="categoryColor" value="#667eea">
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus"></i> Agregar Categoría
                        </button>
                    </form>
                </div>
            </div>

            <!-- Transactions Card -->
            <div class="card">
                <h3><i class="fas fa-exchange-alt"></i> Transacciones</h3>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('transactions-view')">Ver</div>
                    <div class="tab" onclick="switchTab('transactions-add')">Agregar</div>
                </div>
                
                <div id="transactions-view" class="tab-content active">
                    <div id="transactionsList"></div>
                </div>
                
                <div id="transactions-add" class="tab-content">
                    <form id="transactionForm">
                        <div class="form-group">
                            <label for="transactionCategory">Categoría</label>
                            <select id="transactionCategory" required>
                                <option value="">Seleccionar categoría</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionAmount">Monto</label>
                            <input type="number" id="transactionAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionDescription">Descripción</label>
                            <input type="text" id="transactionDescription" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionDate">Fecha</label>
                            <input type="date" id="transactionDate" required>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus"></i> Agregar Transacción
                        </button>
                    </form>
                </div>
            </div>

            <!-- Income Card -->
            <div class="card">
                <h3><i class="fas fa-money-bill-wave"></i> Ingresos</h3>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('income-view')">Ver</div>
                    <div class="tab" onclick="switchTab('income-add')">Agregar</div>
                </div>
                
                <div id="income-view" class="tab-content active">
                    <div id="incomeList"></div>
                </div>
                
                <div id="income-add" class="tab-content">
                    <form id="incomeForm">
                        <div class="form-group">
                            <label for="incomeSource">Fuente de Ingreso</label>
                            <input type="text" id="incomeSource" required>
                        </div>
                        <div class="form-group">
                            <label for="incomeAmount">Monto</label>
                            <input type="number" id="incomeAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="incomeDate">Fecha</label>
                            <input type="date" id="incomeDate" required>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus"></i> Agregar Ingreso
                        </button>
                    </form>
                </div>
            </div>

            <!-- Credit Cards Card -->
            <div class="card">
                <h3><i class="fas fa-credit-card"></i> Tarjetas de Crédito</h3>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('cards-view')">Ver</div>
                    <div class="tab" onclick="switchTab('cards-add')">Agregar</div>
                </div>
                
                <div id="cards-view" class="tab-content active">
                    <div id="creditCardsList"></div>
                </div>
                
                <div id="cards-add" class="tab-content">
                    <form id="creditCardForm">
                        <div class="form-group">
                            <label for="cardName">Nombre de la Tarjeta</label>
                            <input type="text" id="cardName" required>
                        </div>
                        <div class="form-group">
                            <label for="cardLimit">Límite de Crédito</label>
                            <input type="number" id="cardLimit" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="cardBalance">Saldo Actual</label>
                            <input type="number" id="cardBalance" step="0.01" required>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus"></i> Agregar Tarjeta
                        </button>
                    </form>
                </div>
            </div>

            <!-- Charts Card -->
            <div class="card">
                <h3><i class="fas fa-chart-pie"></i> Gráficos</h3>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('chart-expenses')">Gastos</div>
                    <div class="tab" onclick="switchTab('chart-trends')">Tendencias</div>
                    <div class="tab" onclick="switchTab('chart-cards')">Tarjetas</div>
                </div>
                
                <div id="chart-expenses" class="tab-content active">
                    <div class="chart-container">
                        <canvas id="expensesChart"></canvas>
                    </div>
                </div>
                
                <div id="chart-trends" class="tab-content">
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
                
                <div id="chart-cards" class="tab-content">
                    <div class="chart-container">
                        <canvas id="cardsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Budget Suggestions Card -->
            <div class="card">
                <h3><i class="fas fa-lightbulb"></i> Sugerencias de Presupuesto</h3>
                <div id="budgetSuggestions"></div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <button class="btn btn-success" onclick="generatePDF()">
                <i class="fas fa-file-pdf"></i> Generar PDF
            </button>
            <button class="btn btn-secondary" onclick="exportData()">
                <i class="fas fa-download"></i> Exportar Datos
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                <i class="fas fa-upload"></i> Importar Datos
            </button>
            <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
        </div>
    </div>

    <!-- Modals -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('paymentModal')">&times;</button>
            <h3>Realizar Pago a Tarjeta</h3>
            <form id="paymentForm">
                <input type="hidden" id="paymentCardId">
                <div class="form-group">
                    <label for="paymentAmount">Monto del Pago</label>
                    <input type="number" id="paymentAmount" step="0.01" required>
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-credit-card"></i> Realizar Pago
                </button>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global data structure
        let budgetData = {
            categories: [],
            transactions: [],
            income: [],
            creditCards: [],
            monthlyData: []
        };

        // Chart instances
        let charts = {
            expenses: null,
            trends: null,
            cards: null
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            updateUI();
            generateMonthlyData();
        });

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('budgetTrackerData');
            if (savedData) {
                budgetData = JSON.parse(savedData);
            } else {
                // Initialize with sample data
                budgetData = {
                    categories: [
                        { id: 1, name: 'Alimentación', budget: 500, actual: 0, color: '#3498db' },
                        { id: 2, name: 'Transporte', budget: 200, actual: 0, color: '#2ecc71' },
                        { id: 3, name: 'Entretenimiento', budget: 150, actual: 0, color: '#e74c3c' },
                        { id: 4, name: 'Servicios', budget: 300, actual: 0, color: '#f39c12' }
                    ],
                    transactions: [],
                    income: [],
                    creditCards: [],
                    monthlyData: []
                };
                saveData();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('budgetTrackerData', JSON.stringify(budgetData));
        }

        // Setup event listeners
        function setupEventListeners() {
            // Category form
            document.getElementById('categoryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addCategory();
            });

            // Transaction form
            document.getElementById('transactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addTransaction();
            });

            // Income form
            document.getElementById('incomeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addIncome();
            });

            // Credit card form
            document.getElementById('creditCardForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addCreditCard();
            });

            // Payment form
            document.getElementById('paymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                makePayment();
            });

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            document.getElementById('incomeDate').value = today;
        }

        // Tab switching
        function switchTab(tabId) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            const selectedContent = document.getElementById(tabId);
            if (selectedContent) {
                selectedContent.classList.add('active');
            }

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Update charts if chart tab is selected
            if (tabId.includes('chart')) {
                setTimeout(() => updateCharts(), 100);
            }
        }

        // Add category
        function addCategory() {
            const name = document.getElementById('categoryName').value;
            const budget = parseFloat(document.getElementById('categoryBudget').value);
            const color = document.getElementById('categoryColor').value;

            const newCategory = {
                id: Date.now(),
                name: name,
                budget: budget,
                actual: 0,
                color: color
            };

            budgetData.categories.push(newCategory);
            saveData();
            updateUI();
            
            // Reset form
            document.getElementById('categoryForm').reset();
            showNotification('Categoría agregada exitosamente', 'success');
        }

        // Add transaction
        function addTransaction() {
            const category = document.getElementById('transactionCategory').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value;
            const date = document.getElementById('transactionDate').value;

            const newTransaction = {
                id: Date.now(),
                category: category,
                amount: amount,
                description: description,
                date: date
            };

            budgetData.transactions.push(newTransaction);

            // Update category actual amount
            const categoryObj = budgetData.categories.find(cat => cat.name === category);
            if (categoryObj) {
                categoryObj.actual += amount;
            }

            saveData();
            updateUI();
            
            // Reset form
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            showNotification('Transacción agregada exitosamente', 'success');
        }

        // Add income
        function addIncome() {
            const source = document.getElementById('incomeSource').value;
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const date = document.getElementById('incomeDate').value;

            const newIncome = {
                id: Date.now(),
                source: source,
                amount: amount,
                date: date
            };

            budgetData.income.push(newIncome);
            saveData();
            updateUI();
            
            // Reset form
            document.getElementById('incomeForm').reset();
            document.getElementById('incomeDate').value = new Date().toISOString().split('T')[0];
            showNotification('Ingreso agregado exitosamente', 'success');
        }

        // Add credit card
        function addCreditCard() {
            const name = document.getElementById('cardName').value;
            const limit = parseFloat(document.getElementById('cardLimit').value);
            const balance = parseFloat(document.getElementById('cardBalance').value);

            const newCard = {
                id: Date.now(),
                name: name,
                limit: limit,
                balance: balance
            };

            budgetData.creditCards.push(newCard);
            saveData();
            updateUI();
            
            // Reset form
            document.getElementById('creditCardForm').reset();
            showNotification('Tarjeta agregada exitosamente', 'success');
        }

        // Make payment to credit card
        function makePayment() {
            const cardId = parseInt(document.getElementById('paymentCardId').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);

            const card = budgetData.creditCards.find(c => c.id === cardId);
            if (card) {
                card.balance = Math.max(0, card.balance - amount);
                saveData();
                updateUI();
                closeModal('paymentModal');
                showNotification('Pago realizado exitosamente', 'success');
            }
        }

        // Update the entire UI
        function updateUI() {
            updateStatistics();
            updateCategoriesList();
            updateTransactionsList();
            updateIncomeList();
            updateCreditCardsList();
            updateTransactionCategorySelect();
            updateBudgetSuggestions();
            updateCharts();
        }

        // Update statistics
        function updateStatistics() {
            const totalIncome = budgetData.income.reduce((sum, income) => sum + income.amount, 0);
            const totalExpenses = budgetData.transactions.reduce((sum, transaction) => sum + transaction.amount, 0);
            const totalSavings = totalIncome - totalExpenses;
            const totalBudget = budgetData.categories.reduce((sum, category) => sum + category.budget, 0);
            const budgetUsage = totalBudget > 0 ? (totalExpenses / totalBudget * 100) : 0;

            document.getElementById('totalIncomeDisplay').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpensesDisplay').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('totalSavingsDisplay').textContent = `$${totalSavings.toFixed(2)}`;
            document.getElementById('budgetUsageDisplay').textContent = `${budgetUsage.toFixed(1)}%`;
        }

        // Update categories list
        function updateCategoriesList() {
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';

            budgetData.categories.forEach(category => {
                const percentage = category.budget > 0 ? (category.actual / category.budget * 100) : 0;
                const remaining = category.budget - category.actual;

                const categoryElement = document.createElement('div');
                categoryElement.className = 'category-item';
                categoryElement.innerHTML = `
                    <div class="category-info">
                        <div class="category-name">${category.name}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%; background-color: ${category.color}"></div>
                        </div>
                        <div class="category-stats">
                            <span>Presupuesto: $${category.budget.toFixed(2)}</span>
                            <span>Gastado: $${category.actual.toFixed(2)}</span>
                            <span>Restante: $${remaining.toFixed(2)}</span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteCategory(${category.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                categoriesList.appendChild(categoryElement);
            });
        }

        // Update transactions list
        function updateTransactionsList() {
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.innerHTML = '';

            const sortedTransactions = [...budgetData.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentTransactions = sortedTransactions.slice(0, 10);

            recentTransactions.forEach(transaction => {
                const transactionElement = document.createElement('div');
                transactionElement.className = 'transaction-item';
                transactionElement.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-category">${transaction.category}</div>
                        <div class="transaction-description">${transaction.description}</div>
                        <div class="transaction-date">${transaction.date}</div>
                    </div>
                    <div>
                        <div class="transaction-amount">$${transaction.amount.toFixed(2)}</div>
                        <button class="btn btn-danger" onclick="deleteTransaction(${transaction.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                transactionsList.appendChild(transactionElement);
            });
        }

        // Update income list
        function updateIncomeList() {
            const incomeList = document.getElementById('incomeList');
            incomeList.innerHTML = '';

            const sortedIncome = [...budgetData.income].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedIncome.forEach(income => {
                const incomeElement = document.createElement('div');
                incomeElement.className = 'transaction-item';
                incomeElement.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-category">${income.source}</div>
                        <div class="transaction-date">${income.date}</div>
                    </div>
                    <div>
                        <div class="transaction-amount" style="color: #27ae60;">+$${income.amount.toFixed(2)}</div>
                        <button class="btn btn-danger" onclick="deleteIncome(${income.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                incomeList.appendChild(incomeElement);
            });
        }

        // Update credit cards list
        function updateCreditCardsList() {
            const creditCardsList = document.getElementById('creditCardsList');
            creditCardsList.innerHTML = '';

            budgetData.creditCards.forEach(card => {
                const utilization = card.limit > 0 ? (card.balance / card.limit * 100) : 0;
                const available = card.limit - card.balance;

                const cardElement = document.createElement('div');
                cardElement.className = 'credit-card';
                cardElement.innerHTML = `
                    <div class="card-header">
                        <div class="card-name">${card.name}</div>
                        <div class="card-actions">
                            <button class="btn btn-success" onclick="openPaymentModal(${card.id})">
                                <i class="fas fa-credit-card"></i> Pagar
                            </button>
                            <button class="btn btn-danger" onclick="deleteCreditCard(${card.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-balance">
                        <div>Saldo: $${card.balance.toFixed(2)} / $${card.limit.toFixed(2)}</div>
                        <div>Disponible: $${available.toFixed(2)}</div>
                        <div class="balance-bar">
                            <div class="balance-fill" style="width: ${utilization}%"></div>
                        </div>
                    </div>
                `;
                creditCardsList.appendChild(cardElement);
            });
        }

        // Update transaction category select
        function updateTransactionCategorySelect() {
            const select = document.getElementById('transactionCategory');
            select.innerHTML = '<option value="">Seleccionar categoría</option>';

            budgetData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        // Update budget suggestions
        function updateBudgetSuggestions() {
            const suggestionsContainer = document.getElementById('budgetSuggestions');
            const suggestions = generateBudgetSuggestions();

            if (suggestions.length === 0) {
                suggestionsContainer.innerHTML = '<p>¡Excelente! Tu presupuesto está bien equilibrado.</p>';
                return;
            }

            let suggestionsHTML = '';
            suggestions.forEach(suggestion => {
                suggestionsHTML += `
                    <div class="suggestion-item">
                        <div class="suggestion-icon">
                            <i class="${suggestion.icon}"></i>
                        </div>
                        <div>${suggestion.text}</div>
                    </div>
                `;
            });

            suggestionsContainer.innerHTML = suggestionsHTML;
        }

        // Generate budget suggestions
        function generateBudgetSuggestions() {
            const suggestions = [];
            const totalIncome = budgetData.income.reduce((sum, income) => sum + income.amount, 0);
            const totalExpenses = budgetData.transactions.reduce((sum, transaction) => sum + transaction.amount, 0);

            // Check overall budget health
            if (totalExpenses > totalIncome) {
                suggestions.push({
                    icon: 'fas fa-exclamation-triangle',
                    text: 'Tus gastos superan tus ingresos. Considera reducir gastos o aumentar ingresos.'
                });
            }

            // Check savings rate
            const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpenses) / totalIncome * 100) : 0;
            if (savingsRate < 20) {
                suggestions.push({
                    icon: 'fas fa-piggy-bank',
                    text: 'Intenta ahorrar al menos el 20% de tus ingresos para emergencias y objetivos futuros.'
                });
            }

            // Check category overspending
            budgetData.categories.forEach(category => {
                if (category.actual > category.budget) {
                    suggestions.push({
                        icon: 'fas fa-chart-line',
                        text: `Has excedido el presupuesto de ${category.name} por $${(category.actual - category.budget).toFixed(2)}.`
                    });
                }
            });

            // Check credit card utilization
            budgetData.creditCards.forEach(card => {
                const utilization = card.limit > 0 ? (card.balance / card.limit * 100) : 0;
                if (utilization > 30) {
                    suggestions.push({
                        icon: 'fas fa-credit-card',
                        text: `La utilización de ${card.name} es ${utilization.toFixed(1)}%. Mantén por debajo del 30%.`
                    });
                }
            });

            return suggestions;
        }

        // Generate monthly data for trends
        function generateMonthlyData() {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const currentMonth = new Date().getMonth();
            
            budgetData.monthlyData = [];
            
            for (let i = 0; i < 6; i++) {
                const monthIndex = (currentMonth - 5 + i + 12) % 12;
                const monthData = {
                    month: months[monthIndex],
                    income: Math.random() * 1000 + 3000, // Simulated data
                    expenses: Math.random() * 800 + 2000
                };
                budgetData.monthlyData.push(monthData);
            }
        }

        // Update charts
        function updateCharts() {
            updateExpensesChart();
            updateTrendsChart();
            updateCardsChart();
        }

        // Update expenses chart
        function updateExpensesChart() {
            const ctx = document.getElementById('expensesChart');
            if (!ctx) return;

            if (charts.expenses) {
                charts.expenses.destroy();
            }

            const labels = budgetData.categories.map(cat => cat.name);
            const data = budgetData.categories.map(cat => cat.actual);
            const colors = budgetData.categories.map(cat => cat.color);

            charts.expenses = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Gastos por Categoría'
                        }
                    }
                }
            });
        }

        // Update trends chart
        function updateTrendsChart() {
            const ctx = document.getElementById('trendsChart');
            if (!ctx) return;

            if (charts.trends) {
                charts.trends.destroy();
            }

            const labels = budgetData.monthlyData.map(data => data.month);
            const incomeData = budgetData.monthlyData.map(data => data.income);
            const expenseData = budgetData.monthlyData.map(data => data.expenses);

            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ingresos',
                        data: incomeData,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Gastos',
                        data: expenseData,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tendencias de Ingresos vs Gastos'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update cards chart
        function updateCardsChart() {
            const ctx = document.getElementById('cardsChart');
            if (!ctx) return;

            if (charts.cards) {
                charts.cards.destroy();
            }

            if (budgetData.creditCards.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            const labels = budgetData.creditCards.map(card => card.name);
            const balanceData = budgetData.creditCards.map(card => card.balance);
            const availableData = budgetData.creditCards.map(card => card.limit - card.balance);

            charts.cards = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Saldo Actual',
                        data: balanceData,
                        backgroundColor: 'rgba(231, 76, 60, 0.8)'
                    }, {
                        label: 'Disponible',
                        data: availableData,
                        backgroundColor: 'rgba(39, 174, 96, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Estado de Tarjetas de Crédito'
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Delete functions
        function deleteCategory(id) {
            if (confirm('¿Estás seguro de que quieres eliminar esta categoría?')) {
                budgetData.categories = budgetData.categories.filter(cat => cat.id !== id);
                budgetData.transactions = budgetData.transactions.filter(trans => {
                    const category = budgetData.categories.find(cat => cat.name === trans.category);
                    return category !== undefined;
                });
                saveData();
                updateUI();
                showNotification('Categoría eliminada', 'success');
            }
        }

        function deleteTransaction(id) {
            if (confirm('¿Estás seguro de que quieres eliminar esta transacción?')) {
                const transaction = budgetData.transactions.find(trans => trans.id === id);
                if (transaction) {
                    // Update category actual amount
                    const category = budgetData.categories.find(cat => cat.name === transaction.category);
                    if (category) {
                        category.actual -= transaction.amount;
                    }
                    budgetData.transactions = budgetData.transactions.filter(trans => trans.id !== id);
                    saveData();
                    updateUI();
                    showNotification('Transacción eliminada', 'success');
                }
            }
        }

        function deleteIncome(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este ingreso?')) {
                budgetData.income = budgetData.income.filter(income => income.id !== id);
                saveData();
                updateUI();
                showNotification('Ingreso eliminado', 'success');
            }
        }

        function deleteCreditCard(id) {
            if (confirm('¿Estás seguro de que quieres eliminar esta tarjeta?')) {
                budgetData.creditCards = budgetData.creditCards.filter(card => card.id !== id);
                saveData();
                updateUI();
                showNotification('Tarjeta eliminada', 'success');
            }
        }

        // Modal functions
        function openPaymentModal(cardId) {
            document.getElementById('paymentCardId').value = cardId;
            document.getElementById('paymentModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Notification function
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Export/Import functions
        function exportData() {
            const dataStr = JSON.stringify(budgetData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'budget-data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Datos exportados exitosamente', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (confirm('¿Estás seguro de que quieres importar estos datos? Esto sobrescribirá todos los datos actuales.')) {
                            budgetData = importedData;
                            saveData();
                            updateUI();
                            showNotification('Datos importados exitosamente', 'success');
                        }
                    } catch (error) {
                        showNotification('Error al importar datos: Archivo inválido', 'error');
                    }
                };
                reader.readAsText(file);
            }
        }

        // PDF generation
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Title
            doc.setFontSize(20);
            doc.text('Resumen de Presupuesto Personal', 20, 20);
            doc.setFontSize(12);
            doc.text(`Generado el: ${new Date().toLocaleDateString()}`, 20, 30);

            // Summary statistics
            const totalIncome = budgetData.income.reduce((sum, income) => sum + income.amount, 0);
            const totalExpenses = budgetData.transactions.reduce((sum, transaction) => sum + transaction.amount, 0);
            const totalSavings = totalIncome - totalExpenses;

            doc.setFontSize(14);
            doc.text('Resumen General:', 20, 45);
            doc.setFontSize(12);
            doc.text(`Ingresos Totales: $${totalIncome.toFixed(2)}`, 20, 55);
            doc.text(`Gastos Totales: $${totalExpenses.toFixed(2)}`, 20, 65);
            doc.text(`Ahorros: $${totalSavings.toFixed(2)}`, 20, 75);

            // Categories table
            let yPosition = 90;
            doc.setFontSize(14);
            doc.text('Categorías de Presupuesto:', 20, yPosition);
            yPosition += 10;

            const categoryHeaders = ['Categoría', 'Presupuesto', 'Gastado', 'Restante'];
            const categoryData = budgetData.categories.map(cat => [
                cat.name,
                `$${cat.budget.toFixed(2)}`,
                `$${cat.actual.toFixed(2)}`,
                `$${(cat.budget - cat.actual).toFixed(2)}`
            ]);

            doc.autoTable({
                startY: yPosition,
                head: [categoryHeaders],
                body: categoryData,
                theme: 'striped'
            });

            // Credit cards table
            if (budgetData.creditCards.length > 0) {
                yPosition = doc.lastAutoTable.finalY + 20;
                doc.setFontSize(14);
                doc.text('Tarjetas de Crédito:', 20, yPosition);
                yPosition += 10;

                const cardHeaders = ['Tarjeta', 'Límite', 'Saldo', 'Disponible'];
                const cardData = budgetData.creditCards.map(card => [
                    card.name,
                    `$${card.limit.toFixed(2)}`,
                    `$${card.balance.toFixed(2)}`,
                    `$${(card.limit - card.balance).toFixed(2)}`
                ]);

                doc.autoTable({
                    startY: yPosition,
                    head: [cardHeaders],
                    body: cardData,
                    theme: 'striped'
                });
            }

            // Save PDF
            doc.save('presupuesto-personal.pdf');
            showNotification('PDF generado exitosamente', 'success');
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('show');
                }
            });
        }
    </script>
</body>
</html>